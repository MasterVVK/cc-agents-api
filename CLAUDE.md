# CLAUDE.md

Этот файл предоставляет руководство для Claude Code (claude.ai/code) при работе с кодом в этом репозитории.

## Обзор проекта

Это микросервис на базе FastAPI для обработки и анализа документов ППЭЭ (Профессиональная Проектная Экспертная Экспертиза). Система предоставляет семантический поиск, проверку соответствия документов и возможности анализа с помощью LLM.

## Команды

### Запуск приложения
```bash
# Запуск FastAPI сервера
uvicorn main:app --host 0.0.0.0 --port 8002 --reload

# API будет доступен по адресу http://127.0.0.1:8002
# Документация API доступна по адресу http://127.0.0.1:8002/docs
```

### Зависимости
```bash
# Установка всех зависимостей (используйте requirements_fixed.txt при конфликтах версий packaging)
pip install -r requirements.txt

# Необходимые внешние сервисы:
# - Qdrant сервер на localhost:6333
# - Ollama сервер на localhost:11434  
# - Redis сервер (для очередей задач)
```

### Переменные окружения
```bash
# Создайте файл .env на основе .env.example
cp .env.example .env

# Основные переменные:
QDRANT_COLLECTION_NAME=ppee_applications  # Название коллекции в Qdrant
QDRANT_HOST=localhost                     # Хост Qdrant сервера
QDRANT_PORT=6333                         # Порт Qdrant сервера
OLLAMA_KEEP_ALIVE=10s                    # Время хранения модели в памяти Ollama
```

Переменные окружения автоматически загружаются во всех модулях:
- `main.py` - основное приложение
- `app/adapters/qdrant_adapter.py` - адаптер Qdrant
- `ppee_analyzer/vector_store/qdrant_manager.py` - менеджер векторной БД

### Тестирование
```bash
# Тестовые эндпоинты доступны в test_main.http
# Используйте любой HTTP клиент или запросы из файла test_main.http
```

## Архитектура

### Основные компоненты

1. **main.py** - точка входа FastAPI приложения со всеми API эндпоинтами
2. **app/adapters/** - интеграции с внешними сервисами
   - `llm_adapter.py` - интеграция с Ollama LLM с управлением контекстом
   - `qdrant_adapter.py` - операции с векторной базой данных и гибридный поиск
3. **ppee_analyzer/** - конвейер обработки документов
   - `checklist/` - проверка соответствия документов требованиям
   - `document_processor/` - мультимодальный парсинг документов
   - `semantic_chunker/` - интеллектуальная сегментация документов  
   - `vector_store/` - генерация и хранение эмбеддингов

### Основные группы API эндпоинтов

- **Управление системой**: `/system/status`, `/cleanup`, `/preload-models`
- **Обработка документов**: `/index`, `/applications/{id}/*` 
- **Операции поиска**: `/search`, `/analyze`
- **Операции LLM**: `/llm/process`, `/llm/models/*`

### Конвейер обработки

1. **Загрузка документа** → Docling парсер извлекает текст, таблицы, метаданные
2. **Семантическая сегментация** → умное разделение на связные секции
3. **Генерация эмбеддингов** → BGE модель создает векторные представления
4. **Векторное хранилище** → Qdrant сохраняет эмбеддинги с метаданными
5. **Поиск/Анализ** → гибридный поиск + обработка LLM для запросов

### Важные паттерны проектирования

- **Паттерн Адаптер** для внешних сервисов (LLM, векторная БД)
- **Async/await** везде для неблокирующих операций
- **Очистка ресурсов** после GPU-интенсивных операций
- **Redis очереди** для фоновой обработки задач
- **Индексация с метаданными** для точного поиска по документам

## Ключевые технические детали

### Конфигурация векторного поиска
- Использует BGE эмбеддинги (1024 измерения)
- Поддерживает гибридный поиск с настраиваемыми весами вектор/текст
- Переранжирование с BGE reranker для улучшения релевантности
- Фильтрация по метаданным: application_id, content_type, section

### Интеграция LLM
- Ollama сервер предоставляет локальный вывод LLM
- Динамическое управление окном контекста на основе возможностей модели
- Подсчет токенов для отслеживания промпта/генерации
- Обработка отказов модели с резервными вариантами

### Обработка документов
- Обрабатывает множество форматов через Docling
- Сохраняет структуру документа (секции, таблицы, метаданные)
- Семантическая сегментация с перекрытием для сохранения контекста
- Отслеживание номеров страниц и секций для цитирования

## Типичные задачи разработки

### Добавление новых эндпоинтов
Новые эндпоинты следует добавлять в main.py, следуя существующим паттернам FastAPI с правильной обработкой ошибок и асинхронными операциями.

### Изменение поведения поиска
Логика поиска находится в `app/adapters/qdrant_adapter.py` - настраивайте веса, фильтры или параметры переранжирования там.

### Смена LLM моделей
Обновите имена моделей в `app/adapters/llm_adapter.py` или передайте другие параметры модели в эндпоинт `/llm/process`.

### Управление памятью
Всегда вызывайте эндпоинты очистки после GPU-интенсивных операций. Система включает автоматическую очистку в обработчиках ошибок.